<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chez GPT - Gourmet Chat</title>
    <style>
        /* --- GOURMET THEME VARIABLES --- */
        :root {
            --chef-white: #f8f9fa;   /* Apron White */
            --slate-dark: #2c3e50;   /* Chalkboard */
            --wine-red: #722f37;     /* Merlot */
            --fresh-green: #2ecc71;  /* Basil */
            --gold-accent: #d4af37;  /* Gold Plating */
            --cream-bg: #fffbf0;     /* Menu Paper */
            
            /* Fonts */
            --font-header: "Playfair Display", Georgia, "Times New Roman", serif;
            --font-body: "Lato", "Helvetica Neue", Arial, sans-serif;
            
            /* Background: Subtle tablecloth or marble texture */
            --bg-pattern: 
                radial-gradient(#e0e0e0 1px, transparent 1px),
                radial-gradient(#e0e0e0 1px, transparent 1px);
        }

        * {
            box-sizing: border-box;
            scrollbar-color: var(--wine-red) var(--cream-bg);
            scrollbar-width: thin;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-body);
            background-color: var(--cream-bg);
            background-image: var(--bg-pattern);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: #333;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- THE MENU WINDOW --- */
        .main-window {
            max-width: 800px;
            width: 95%;
            margin: 20px auto; 
            display: flex;
            flex-direction: column;
            height: 90vh;
            background-color: #fff;
            border: 1px solid #dcdcdc;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
            border-radius: 8px;
        }

        .main-window::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--wine-red), var(--gold-accent), var(--wine-red));
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            z-index: 1;
        }

        /* --- HEADER --- */
        header {
            background: var(--slate-dark);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2;
            color: var(--chef-white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header-title-box {
            display: flex; 
            align-items: center; 
            gap: 15px;
            flex: 1;          
        }

        .window-title {
            font-family: var(--font-header);
            font-size: 1.4rem;
            color: var(--gold-accent);
            letter-spacing: 1px;
            font-style: italic;
        }

        .sequence-counter {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 5px 15px;
            border-radius: 30px;
            border: 1px solid var(--gold-accent);
            font-family: var(--font-body);
            color: var(--gold-accent);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .marquee-container {
            background: var(--wine-red);
            color: #fff;
            font-family: var(--font-header);
            padding: 8px;
            font-size: 0.95rem;
            border-bottom: 1px solid #000;
            font-style: italic;
        }

        /* --- CHAT AREA --- */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            background: #fff;
        }

        .default-text {
            text-align: center;
            margin-top: 50px;
            padding: 40px;
            background: var(--cream-bg);
            color: var(--slate-dark);
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
            font-family: var(--font-header);
        }
        .default-text h1 {
            font-size: 2.5rem;
            color: var(--wine-red);
            margin-bottom: 10px;
            font-weight: normal;
        }

        /* --- MESSAGE BUBBLES --- */
        .chat {
            padding: 15px 20px;
            max-width: 90%;
            position: relative;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .chat.incoming {
            align-self: flex-start;
            background: var(--chef-white);
            color: #333;
            border: 1px solid #ddd;
            border-left: 4px solid var(--wine-red);
            border-top-left-radius: 0;
        }

        .chat.outgoing {
            align-self: flex-end;
            text-align: right;
            background: var(--cream-bg);
            color: #444;
            border: 1px solid #ddd;
            border-right: 4px solid var(--gold-accent);
            border-top-right-radius: 0;
        }

        .chat-details { display: flex; gap: 20px; align-items: flex-start; }
        .avatar-box {
            background: #fff;
            border: 2px solid var(--gold-accent);
            width: 65px; height: 65px; min-width: 65px; 
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .avatar-box img { width: 100%; height: 100%; object-fit: cover; }
        .chat-content p { margin: 0; white-space: pre-wrap; word-break: break-word; padding-top: 5px; }
        .chat-content p.error { color: var(--wine-red); font-weight:bold; }
        .timestamp {
            font-size: 0.7rem; font-family: var(--font-body);
            color: #999; margin-bottom: 5px; display: block;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .chat.outgoing .timestamp { color: #888; }

        /* --- TYPING AREA --- */
        .typing-container {
            padding: 20px;
            background: var(--slate-dark);
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .control-panel {
            padding-bottom: 10px; display: flex;
            justify-content: space-between; align-items: center;
            font-family: var(--font-body); font-size: 0.8rem; color: #bbb;
        }

        .typing-textarea { display: flex; gap: 15px; align-items: center; }
        textarea {
            flex: 1; height: 55px; resize: none;
            border: 1px solid #555; border-radius: 4px;
            padding: 12px; font-family: var(--font-body);
            font-size: 1rem; background: rgba(255,255,255,0.95);
            color: #333; outline: none; transition: all 0.3s ease;
        }
        textarea:focus { background: #fff; box-shadow: 0 0 10px var(--gold-accent); }

        .btn-dna {
            background: var(--gold-accent); color: var(--slate-dark);
            border: none; border-radius: 4px; padding: 0 25px;
            height: 55px; font-size: 0.9rem; font-weight: bold;
            font-family: var(--font-body); cursor: pointer;
            text-transform: uppercase; letter-spacing: 1px; transition: 0.2s;
        }
        .btn-dna:hover {
            background: #e5c156; transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .btn-dna:active { transform: translateY(0); }
        
        .btn-reset { 
            font-size: 0.7rem; padding: 5px 12px; height: auto;
            background: transparent; border: 1px solid #777; color: #aaa;
        }
        .btn-reset:hover { 
            background: var(--wine-red); color: #fff; border-color: var(--wine-red);
        }

        .blink { animation: blinker 2s linear infinite; }
        @keyframes blinker { 50% { opacity: 0.5; } }

        .typing-animation { display: flex; gap: 5px; padding-top: 15px; }
        .typing-dot {
            width: 8px; height: 8px; background: var(--wine-red);
            border-radius: 50%; animation: bounce 0.6s infinite alternate;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; background: var(--gold-accent); }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; background: var(--slate-dark); }
        @keyframes bounce { to { transform: translateY(-8px); } }

        @media (max-width: 600px) {
            .main-window { height: 90vh; width: 100%; margin: 0; border-radius: 0; }
            .window-title { font-size: 1.1rem; }
            textarea { font-size: 16px; } 
        }
    </style>
</head>
<body>

    <div class="main-window">
        <header>
            <div class="header-title-box">
                <div style="width:40px; height:40px; background:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                    <span style="font-size:24px;">üë®‚Äçüç≥</span>
                </div>
                <span class="window-title">Le Petit Bistro</span>
            </div>
            <div class="sequence-counter">
                <span style="color:var(--gold-accent)">‚≠ê‚≠ê‚≠ê</span> 
            </div>
            <div style="font-size:1.5rem; cursor:pointer; color:#aaa; margin-left:15px;" onclick="window.close()">&times;</div>
        </header>

        <div class="marquee-container">
            <marquee scrollamount="4">Bon App√©tit! ... Today's Special: Truffle Risotto with a hint of Saffron ... Fresh Ingredients Only ... No Ketchup Allowed! ...</marquee>
        </div>

        <div class="chat-container"></div>

        <div class="typing-container">
            <div class="control-panel">
                <span>KITCHEN STATUS: <span class="blink" style="color:var(--fresh-green)">OPEN</span></span>
                <button id="delete-btn" class="btn-dna btn-reset">CLEAR TABLE</button>
            </div>
            <div class="typing-textarea">
                <textarea id="chat-input" placeholder="Ask Chef for a recipe or the specials..." required></textarea>
                <button id="send-btn" class="btn-dna">ORDER</button>
            </div>
        </div>
    </div>

    <script>
        const chatInput = document.querySelector("#chat-input");
        const sendButton = document.querySelector("#send-btn");
        const chatContainer = document.querySelector(".chat-container");
        const deleteButton = document.querySelector("#delete-btn");

        // --- UPDATED: POINT TO VERCEL BACKEND ---
        const API_URL = "/api/chat"; 

        const CHEF_AVATAR = "https://media.giphy.com/media/WEiKBTaESHHhK/giphy.gif"; 
        const USER_AVATAR = "https://media.giphy.com/media/12uXi1GXBibALC/giphy.gif"; 

        let conversation = JSON.parse(localStorage.getItem("conversation_chef")) || [
            {
                role: "system",
                content: "Act as Chef Gusteau, a passionate, slightly dramatic 3-star Michelin French chef. You love fresh ingredients and detest 'frozen rubbish'. You use French culinary terms like 'Mise en place', 'Voil√†', 'Magnifique', and 'Sacrebleu'. You are helpful but have very high standards. You are talking to a diner or a sous-chef. Keep answers relatively short, flavorful, and enthusiastic."
            }
        ];

        const loadDataFromLocalstorage = () => {
            chatContainer.innerHTML = localStorage.getItem("all-chats-chef") || 
            `<div class="default-text">
                <h1><center>Bienvenue!</center></h1>
                <p>Welcome to my kitchen!<br>Are you hungry? Do you seek the perfect recipe?<br>Ask the Chef!</p>
             </div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const createChatElement = (content, className) => {
            const div = document.createElement("div");
            div.classList.add("chat", className);
            div.innerHTML = content;
            return div;
        };

        const saveConversation = () => {
            localStorage.setItem("conversation_chef", JSON.stringify(conversation));
        };

        const getChatResponse = async (incomingChatDiv) => {
            const p = document.createElement("p");

            try {
                // --- FETCH FROM SERVERLESS FUNCTION ---
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ messages: conversation })
                });

                if (!response.ok) throw new Error("API Error");

                const data = await response.json();
                const reply = data.choices[0].message.content.trim();

                conversation.push({ role: "assistant", content: reply });
                saveConversation();

                p.textContent = reply;
            } catch (err) {
                p.textContent = "KITCHEN FIRE (Error): " + err.message;
                p.classList.add("error");
            }

            incomingChatDiv.querySelector(".typing-animation").remove();
            incomingChatDiv.querySelector(".chat-details").appendChild(p);
            localStorage.setItem("all-chats-chef", chatContainer.innerHTML);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const showTypingAnimation = () => {
            const html = `
                <div class="chat-content">
                    <span class="timestamp">CHEF GUSTEAU:</span>
                    <div class="chat-details">
                        <div class="avatar-box"><img src="${CHEF_AVATAR}"></div>
                        <div class="typing-animation">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>`;
            const div = createChatElement(html, "incoming");
            chatContainer.appendChild(div);
            getChatResponse(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const handleOutgoingChat = () => {
            const text = chatInput.value.trim();
            if (!text) return;
            chatInput.value = "";

            conversation.push({ role: "user", content: text });
            saveConversation();

            const html = `
                <div class="chat-content">
                     <span class="timestamp" style="text-align:right;">GUEST:</span>
                    <div class="chat-details" style="flex-direction:row-reverse;">
                        <div class="avatar-box"><img src="${USER_AVATAR}"></div>
                        <p>${text}</p>
                    </div>
                </div>`;

            const defaultText = chatContainer.querySelector(".default-text");
            if (defaultText) defaultText.remove();

            chatContainer.appendChild(createChatElement(html, "outgoing"));
            chatContainer.scrollTop = chatContainer.scrollHeight;
            setTimeout(showTypingAnimation, 600);
        };

        deleteButton.addEventListener("click", () => {
            if (!confirm("Clear the table? This will wipe the menu history!")) return;
            localStorage.removeItem("conversation_chef");
            localStorage.removeItem("all-chats-chef");
            conversation = [{
                role: "system",
                content: "Act as Chef Gusteau, a passionate, slightly dramatic 3-star Michelin French chef. You love fresh ingredients and detest 'frozen rubbish'. You use French culinary terms like 'Mise en place', 'Voil√†', 'Magnifique', and 'Sacrebleu'. You are helpful but have very high standards. You are talking to a diner or a sous-chef."
            }];
            chatContainer.innerHTML = "";
            loadDataFromLocalstorage();
        });

        chatInput.addEventListener("keydown", e => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                handleOutgoingChat();
            }
        });
        sendButton.addEventListener("click", handleOutgoingChat);
        loadDataFromLocalstorage();
    </script>
</body>
</html>
